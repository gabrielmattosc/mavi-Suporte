{% extends "base.html" %}

{% block title %}Relat칩rios - Mavi Suporte{% endblock %}

{% block content %}
<div class="container fade-in">
    <header>
        <h1>游늳 Relat칩rios e An치lises</h1>
    </header>

    {% if error %}
        <div class="error-message">{{ error }}</div>
    {% else %}
        {% if session.user.role == 'admin' %}
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">
                    <i class="fas fa-chart-pie"></i>
                    Dashboard Avan칞ado
                </h2>
            </div>
            
            <div class="card-content">
                <!-- Linha de Cima: Dois gr치ficos m칠dios -->
                <div class="charts-grid-2">
                    <div class="chart-card">
                        <h3>Distribui칞칚o por Status</h3>
                        <div class="chart-container" id="status-chart-container">
                            <p class="loading-text">A carregar...</p>
                        </div>
                    </div>
                    <div class="chart-card">
                        <h3>Top Dispositivos Solicitados</h3>
                        <div class="chart-container" id="dispositivos-chart-container">
                            <p class="loading-text">A carregar...</p>
                        </div>
                    </div>
                </div>

                <!-- Linha de Baixo: Um gr치fico grande -->
                <div class="timeline-section">
                    <div class="chart-card">
                        <h3>Tickets Criados por Dia</h3>
                        <div class="chart-container" id="timeline-chart-container">
                            <p class="loading-text">A carregar...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- NOVA SE칂츾O DE EXPORTA칂츾O NO FINAL -->
        <section class="export-section">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">
                        <i class="fas fa-download"></i>
                        Exportar Dados
                    </h2>
                </div>
                <div class="card-content" style="text-align: center;">
                    <p>Fa칞a o download de um relat칩rio completo com todos os tickets em formato Excel.</p>
                    <a href="{{ url_for('export.export_excel') }}" class="btn btn-export">
                        <i class="fas fa-file-excel"></i> Extrair Relat칩rio Completo (.xlsx)
                    </a>
                </div>
            </div>
        </section>

        {% endif %}
    {% endif %}
</div>

<!-- Script para renderizar os gr치ficos (n칚o precisa de ser alterado) -->
{% if session.user.role == 'admin' and not error %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const apiUrl = "{{ url_for('graphics.get_all_graphics') }}";

        fetch(apiUrl)
            .then(response => response.json())
            .then(data => {
                const statusContainer = document.getElementById('status-chart-container');
                if (data.status) {
                    const graphStatus = JSON.parse(data.status);
                    statusContainer.innerHTML = '';
                    Plotly.newPlot(statusContainer, graphStatus.data, graphStatus.layout, {responsive: true});
                } else { statusContainer.innerHTML = '<p class="error-text">Erro ao carregar.</p>'; }

                const dispositivosContainer = document.getElementById('dispositivos-chart-container');
                if (data.dispositivos) {
                    const graphDispositivos = JSON.parse(data.dispositivos);
                    dispositivosContainer.innerHTML = '';
                    Plotly.newPlot(dispositivosContainer, graphDispositivos.data, graphDispositivos.layout, {responsive: true});
                } else { dispositivosContainer.innerHTML = '<p>Nenhum dado.</p>'; }

                const timelineContainer = document.getElementById('timeline-chart-container');
                if (data.timeline) {
                    const graphTimeline = JSON.parse(data.timeline);
                    timelineContainer.innerHTML = '';
                    Plotly.newPlot(timelineContainer, graphTimeline.data, graphTimeline.layout, {responsive: true});
                } else { timelineContainer.innerHTML = '<p class="error-text">Erro ao carregar.</p>'; }
            })
            .catch(error => console.error('Erro:', error));
    });
</script>
{% endif %}
{% endblock %}
